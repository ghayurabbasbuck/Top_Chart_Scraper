"""
TopChart_Data.py

Utility functions to read Top Chart CSV files (App Store export format).
"""

from typing import List, Dict, Optional
import csv
import datetime
import io
import os


def _parse_iso_datetime(value: str) -> Optional[datetime.datetime]:
    if not value:
        return None
    try:
        return datetime.datetime.fromisoformat(value.replace("Z", "+00:00"))
    except Exception:
        return None


def read_topchart_csv(
    filepath: str,
    encoding: str = "utf-8",
    parse_dates: bool = False,
) -> List[Dict[str, object]]:
    """
    Read a Top Chart CSV and return a list of records (as dicts).

    Each row is returned as a dict mapping column name to value. If parse_dates
    is True, the "launch_date" and "update_date" columns (if present) will be
    converted to datetime.datetime objects when possible.

    Raises:
        FileNotFoundError: if the file does not exist.
        UnicodeDecodeError: if the file cannot be decoded with the given encoding.
        csv.Error: if there is a CSV parsing error.
    """
    if not os.path.exists(filepath):
        raise FileNotFoundError(f"File not found: {filepath}")

    records: List[Dict[str, object]] = []
    with open(filepath, "r", encoding=encoding, newline="") as fh:
        reader = csv.DictReader(fh)
        for row in reader:
            # Normalize empty strings to None for clarity
            normalized = {k: (v if v != "" else None) for k, v in row.items()}
            if parse_dates:
                for date_col in ("launch_date", "update_date"):
                    if date_col in normalized and normalized[date_col]:
                        parsed = _parse_iso_datetime(normalized[date_col])
                        normalized[date_col] = parsed
            records.append(normalized)
    return records


def read_topchart_csv_from_string(
    csv_text: str, parse_dates: bool = False
) -> List[Dict[str, object]]:
    """
    Read Top Chart CSV content from a string. Useful for tests or clipboard data.
    """
    with io.StringIO(csv_text) as buf:
        reader = csv.DictReader(buf)
        records: List[Dict[str, object]] = []
        for row in reader:
            normalized = {k: (v if v != "" else None) for k, v in row.items()}
            if parse_dates:
                for date_col in ("launch_date", "update_date"):
                    if date_col in normalized and normalized[date_col]:
                        normalized[date_col] = _parse_iso_datetime(normalized[date_col])
            records.append(normalized)
        return records


if __name__ == "__main__":
    # Example usage (keeps output minimal for script mode)
    import sys
    path = sys.argv[1] if len(sys.argv) > 1 else "topchart_a_Business.csv"
    try:
        data = read_topchart_csv(path, parse_dates=True)
        print(f"Read {len(data)} records from {path}")
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)